# é¡¹ç›®ï¼šçƒŸç«è¯„è¿¹



## åŠŸèƒ½æ¨¡å—1ï¼šçŸ­ä¿¡ç™»é™†

##### ï¼ˆ1ï¼‰åŸºäºsessionå®ç°çŸ­ä¿¡ç™»å½•

![image-20250804143804966](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250804143804966.png)



Tomcaté›†ç¾¤ä¸­ï¼Œsessionçš„å…±äº«é—®é¢˜ï¼š

â€‹	é—®é¢˜ï¼šå½“æˆ‘ä»¬ä½¿ç”¨nginxè´Ÿè½½å‡è¡¡äº†å¤šå°tomcatæœåŠ¡å™¨ï¼Œæ¯å°æœåŠ¡å™¨éƒ½æœ‰å„è‡ªç‹¬ç«‹çš„sessionåŸŸï¼Œå½“æœ¬æ¬¡ç”¨æˆ·ç™»å½•æ—¶åˆ†é…åˆ°äº†tomcatAï¼Œå°†ç™»å½•ä¿¡æ¯å­˜åˆ°AæœåŠ¡å™¨ä¸­ï¼›è‹¥è¯¥ç”¨æˆ·å†æ¬¡è®¿é—®tomcaté›†ç¾¤ï¼Œå¯èƒ½è½®è¯¢åˆ†é…åˆ°tomcatBï¼Œè¯¥BæœåŠ¡å™¨çš„sessionåŸŸä¸­ä¸åŒ…å«å½“å‰ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ï¼Œé€ æˆå…±äº«é—®é¢˜ã€‚

â€‹	è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨redisæ¥å­˜å‚¨ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ï¼Œtomcaté›†ç¾¤çš„æ¯å°æœåŠ¡å™¨éƒ½ä»redisè·å–ä¿¡æ¯ï¼Œä¸ä¼šé‡åˆ°sessionçš„å…±äº«é—®é¢˜ã€‚

![image-20250804170801746](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250804170801746.png)



##### ï¼ˆ2ï¼‰åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•

![image-20250804185939655](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250804185939655.png)

![image-20250804191719286](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250804191719286.png)

å¦‚ä¸Šå›¾ï¼š

â€‹	é—®ï¼šå¦‚ä½•ä½¿ç”¨ token + redis å­˜å‚¨ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼Ÿ

â€‹	ç­”ï¼šâ‘ å½“ç”¨æˆ·ç™»å½•åï¼Œåœ¨åç«¯ç”Ÿæˆéšæœºå­—ç¬¦ä¸²tokenä½œä¸ºkeyï¼Œå°†userå¯¹è±¡ä½œä¸ºvalueï¼Œå­˜å…¥redisä¸­ã€‚

â€‹			â‘¡å°†tomcatä¸­ç”Ÿæˆçš„tokenä¼ é€’ç»™å‰ç«¯ï¼Œç”±å‰ç«¯è¿›è¡Œå­˜è´®ï¼›ä¹‹åæ¯æ¬¡å‰ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œéƒ½æºå¸¦tokenï¼Œåç«¯å°±èƒ½åœ¨redisä¸­æ‰¾åˆ°è¯¥tokenå¯¹åº”çš„ç”¨æˆ·ç™»å½•ä¿¡æ¯userã€‚



æ³¨æ„ï¼šsessionå®ç°ç™»å½•è®¤è¯ï¼Œä¸rediså®ç°ç™»å½•è®¤è¯ï¼Œæœ‰è¯¸å¤šå…±åŒç‚¹ï¼

â€‹	â‘ cookieç±»æ¯”tokenï¼Œredisç±»æ¯”sessionï¼ŒäºŒè€…çš„è¿è¡Œæµç¨‹æ˜¯ç±»ä¼¼çš„ã€‚

â€‹	â‘¡cookieå’Œtokenï¼Œéƒ½æ˜¯åœ¨åç«¯ç”Ÿæˆï¼Œæœ€ç»ˆå­˜å‚¨åœ¨å‰ç«¯ï¼Œæ¯æ¬¡å‰ç«¯è¯·æ±‚åç«¯æ—¶éƒ½å°†å…¶æºå¸¦ã€‚

â€‹	â‘¢redisé€šè¿‡tokenä½œä¸ºkeyï¼Œè·å–å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯valueï¼›è€ŒæœåŠ¡å™¨é€šè¿‡cookieä¸­å­˜æ”¾çš„sessionçš„idï¼Œæ‰¾åˆ°å¯¹åº”çš„sessionç©ºé—´ã€‚

â€‹	â‘£äºŒè€…çš„åŒºåˆ«åœ¨äºï¼šcookieç”±æµè§ˆå™¨è‡ªåŠ¨ç®¡ç†ï¼Œè€Œtokenç”±å‰ç«¯ç¨‹åºå‘˜æ‰‹æ®µç®¡ç†ã€‚



##### ï¼ˆ3ï¼‰ç™»å½•æ‹¦æˆªå™¨çš„ä¼˜åŒ–

![image-20250804220231760](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250804220231760.png)

åç«¯redisä¸­ï¼Œé”®å€¼å¯¹ [k:token - v:userç™»å½•ä¿¡æ¯] çš„æœ‰æ•ˆæœŸï¼šé¦–æ¬¡åˆ›å»º30åˆ†é’Ÿåè¿‡æœŸï¼Œæ¯æ¬¡è¯·æ±‚åˆ·æ–°è¿‡æœŸæ—¶é—´ï¼

â€‹	-- å•å±‚æ‹¦æˆªå™¨ç¼ºç‚¹ï¼šä»…åœ¨è®¿é—®éœ€è¦æ‹¦æˆªçš„è·¯å¾„æ—¶åˆ·æ–°è¿‡æœŸæ—¶é—´ï¼Œå½“ç”¨æˆ·è®¿é—®æ”¾è¡Œè·¯å¾„æ—¶ï¼ˆä¸è¿›å…¥æ‹¦æˆªå™¨ï¼‰ä¸åˆ·æ–°è¿‡æœŸæ—¶é—´ã€‚

â€‹	-- åŒå±‚æ‹¦æˆªå™¨ï¼šå¯¹äºæ‰€æœ‰è¯·æ±‚ï¼Œéƒ½åˆ·æ–°tokençš„è¿‡æœŸæ—¶é—´ã€‚





## åŠŸèƒ½æ¨¡å—2ï¼šå•†æˆ·æŸ¥è¯¢ç¼“å­˜

##### ï¼ˆ1ï¼‰ç¼“å­˜æ¦‚å¿µ

![image-20250805085132522](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805085132522.png)

![image-20250805085525342](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805085525342.png)



##### ï¼ˆ2ï¼‰æ·»åŠ å•†æˆ·ç¼“å­˜

ç¼“å­˜æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

![image-20250805094718381](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805094718381.png)



##### ï¼ˆ3ï¼‰ç¼“å­˜çš„æ›´æ–°

â‘ ç¼“å­˜æ›´æ–°çš„å‡ ç§ç­–ç•¥å¦‚ä¸‹ï¼š

![image-20250805103235868](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805103235868.png)

â‘¡ä¸»åŠ¨æ›´æ–°ç¼“å­˜çš„å‡ ç§ç­–ç•¥å¦‚ä¸‹ï¼š

![image-20250805103908407](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805103908407.png)

â‘¢æ‰‹åŠ¨æ›´æ–°ç¼“å­˜çš„ç»†èŠ‚ï¼š

![image-20250805105433907](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805105433907.png)

å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œæ—¶ï¼Œç¼“å­˜æ›´æ–°çš„å®‰å…¨é—®é¢˜ï¼š

å¦‚ä¸‹åˆ†æè¿‡ç¨‹ï¼Œè™½ç„¶äºŒè€…éƒ½å­˜åœ¨å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯ [å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜] å‡ºç°é—®é¢˜çš„æ¦‚ç‡æ›´ä½ã€‚æ— è®ºä½¿ç”¨å“ªç§ï¼Œéƒ½è¦æ·»åŠ è¶…æ—¶æ—¶é—´ï¼Œå®šæœŸæ¸…é™¤ç¼“å­˜æ•°æ®ï¼Œå‡å°‘é—®é¢˜çš„å‘ç”Ÿã€‚

![image-20250805110445137](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805110445137.png)

â‘£æ€»ç»“ï¼š

![image-20250805111822244](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805111822244.png)



##### ï¼ˆ4ï¼‰ç¼“å­˜ç©¿é€

ç¼“å­˜ç©¿é€çš„æ¦‚å¿µåŠè§£å†³æ–¹æ¡ˆï¼š

![image-20250805134208759](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805134208759.png)

å¦‚ä¸‹ï¼šä½¿ç”¨â€œç¼“å­˜ç©ºå¯¹è±¡â€æ¥è§£å†³ç¼“å­˜ç©¿é€

![image-20250805141047154](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805141047154.png)



##### ï¼ˆ5ï¼‰ç¼“å­˜é›ªå´©

ç¼“å­˜é›ªå´©çš„æ¦‚å¿µåŠè§£å†³æ–¹æ¡ˆï¼š

![image-20250805150318617](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805150318617.png)



##### ï¼ˆ6ï¼‰ç¼“å­˜å‡»ç©¿

â‘ ç¼“å­˜å‡»ç©¿çš„æ¦‚å¿µï¼š

![image-20250805152637000](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805152637000.png)

ç¼“å­˜å‡»ç©¿çš„è§£å†³æ–¹æ¡ˆï¼ˆäº’æ–¥é” / é€»è¾‘è¿‡æœŸï¼‰ï¼š

![image-20250805154747035](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805154747035.png)

![image-20250805155955742](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805155955742.png)



â‘¡åŸºäºâ€œäº’æ–¥é”â€è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜

![image-20250805162602025](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805162602025.png)



â‘¢åŸºäºâ€œé€»è¾‘è¿‡æœŸâ€è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜

![image-20250805193633954](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250805193633954.png)



##### ï¼ˆ7ï¼‰å°è£…Redisç¼“å­˜ç›¸å…³æ–¹æ³•çš„å·¥å…·ç±»

![image-20250806090254549](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806090254549.png)





## åŠŸèƒ½æ¨¡å—3ï¼šä¼˜æƒ åˆ¸ç§’æ€

##### ï¼ˆ1ï¼‰å…¨å±€å”¯ä¸€ID

![image-20250806145722565](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806145722565.png)

å…¨å±€IDç”Ÿæˆç­–ç•¥ï¼š

![image-20250806150639268](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806150639268.png)



##### (2)å®ç°ç§’æ€ä¸‹å•

ç§’æ€ä¸‹å•ï¼šè´­ä¹°ç§’æ€ä¼˜æƒ åˆ¸ï¼Œç”Ÿæˆè®¢å•

![image-20250806173232770](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806173232770.png)



##### ï¼ˆ3ï¼‰åº“å­˜è¶…å–é—®é¢˜

â‘ è¶…å–é—®é¢˜ï¼šå¤šçº¿ç¨‹å¹¶å‘çš„å®‰å…¨é—®é¢˜

ä¾‹å¦‚ï¼šç§’æ€æ‰§è¡Œæµç¨‹ä¸ºâ… æŸ¥è¯¢åº“å­˜ï¼Œâ…¡æ‰£å‡åº“å­˜ï¼›è‹¥åŸæœ¬åº“å­˜ä¸º1ï¼Œ10000ä¸ªçº¿ç¨‹åŒæ—¶å¹¶å‘æŸ¥è¯¢åº“å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹æŸ¥è¯¢çš„åº“å­˜ç»“æœéƒ½ä¸º1ï¼Œåˆ™10000ä¸ªçº¿ç¨‹éƒ½æˆåŠŸé€šè¿‡ã€‚ä¹‹å10000ä¸ªçº¿ç¨‹å‡è¦æ‰£å‡åº“å­˜ï¼Œåº“å­˜æœ€ç»ˆä¸º-9999ã€‚

![image-20250806190404504](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806190404504.png)

è¶…å–é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼šåŠ é”ï¼ˆæ‚²è§‚é” / ä¹è§‚é”ï¼‰

![image-20250806192350768](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806192350768.png)



â‘¡ä¹è§‚é”çš„å®ç°æ–¹å¼

â€‹	<ä¹è§‚é”å®ç°æ–¹å¼1>ï¼š**ç‰ˆæœ¬å·æ³•**

â€‹	ç‰ˆæœ¬å·æ³•ä¹è§‚é”ï¼šæ ¸å¿ƒã€sqlè¯­å¥çš„åŸå­æ€§ã€‘

â€‹	å®ç°æ–¹å¼ï¼šå½“æ‰§è¡ŒæŸ¥è¯¢æ“ä½œæ—¶ï¼Œè®°å½•ç‰ˆæœ¬å·version=1ã€‚ä¹‹åè¿›è¡Œæ›´æ–°è¯­å¥æ—¶ï¼Œupdate ... set ..., version=version+1 where ... and  version=1ã€‚ç”±äºsqlè¯­å¥å…·æœ‰åŸå­æ€§ï¼Œå› æ­¤æœ¬æ¡updateè¯­å¥æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶å®ƒå¹¶å‘çš„çº¿ç¨‹æ‰€å½±å“ã€‚å› æ­¤ï¼Œè‹¥10000æ¡çº¿ç¨‹å¹¶å‘æ‰§è¡Œæ—¶ï¼Œä»…æœ‰é¦–æ¡æ‰§è¡Œupdateè¯­å¥çš„çº¿ç¨‹ï¼Œå…¶versionç‰ˆæœ¬å·å…ˆåä¸€è‡´ï¼ŒæˆåŠŸæ‰§è¡Œäº†updateè¯­å¥ã€‚å½“ä¹‹åçš„9999æ¡çº¿ç¨‹æ‰§è¡Œupdateè¯­å¥æ‰§è¡Œæ—¶ï¼Œwhereæ¡ä»¶å‡ä¸æˆç«‹ã€‚ä¿è¯äº†10000æ¡çº¿ç¨‹ä¸­ï¼Œåªæœ‰æœ€å…ˆæ‰§è¡Œupdateè¯­å¥çš„çº¿ç¨‹æ‰§è¡ŒæˆåŠŸï¼Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼

â€‹	ï¼ˆp.s. ä¸ªäººç†è§£ï¼šå‡è®¾æœ‰10000æ¡çº¿ç¨‹ï¼Œ100ä¸ªåº“å­˜ã€‚å½“10000æ¡çº¿ç¨‹å¹¶å‘æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°å­˜é‡ä¸º100ï¼Œç‰ˆæœ¬ä¸º1ï¼Œ10000æ¡çº¿ç¨‹å‡æˆåŠŸé€šè¿‡ã€‚ä¹‹å10000æ¡çº¿ç¨‹äº‰æŠ¢updateè¯­å¥çš„æ‰§è¡Œæƒï¼Œé¦–æ¡äº‰æŠ¢åˆ°updateè¯­å¥çš„çº¿ç¨‹ï¼Œå…¶ç‰ˆæœ¬å·æ­£ç¡®ï¼Œupdateè¯­å¥æ‰§è¡ŒæˆåŠŸï¼Œä¿®æ”¹ç‰ˆæœ¬å·ä¸º2ï¼›è€Œä¹‹åæ‰§è¡Œupdateè¯­å¥çš„çº¿ç¨‹ï¼Œå…¶ç‰ˆæœ¬å·å·²ç»è½åï¼Œå‡æ‰§è¡Œå¤±è´¥ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œè™½ç„¶â€œä¹è§‚é”â€ä¸ä¼šæ˜¾å¼çš„åŠ é”ï¼Œä½†æ˜¯ç”±äºsqlè¯­å¥çš„åŸå­æ€§ï¼Œè¿™æ¡sqlè¯­å¥+ç‰ˆæœ¬å·è¢«è§†ä¸ºäº†ä¸€ä¸ªé”ï¼‰

![image-20250806195034802](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806195034802.png)



<ä¹è§‚é”å®ç°æ–¹å¼2>ï¼š**CASæ³•**

â€‹	CASæ³•ï¼Œå³Compare-And-Setï¼ˆæ¯”è¾ƒå¹¶è®¾ç½®ï¼‰ã€‚CASæ³•çš„åŸç†ï¼Œä¸ç‰ˆæœ¬å·æ³•å®Œå…¨ä¸€è‡´ï¼

â€‹	å¦‚ä¸‹æ¡ˆä¾‹ä¸­ï¼Œä½¿ç”¨åº“å­˜æ•°é‡ä»£æ›¿äº†ç‰ˆæœ¬å·ã€‚æ‰§è¡Œupdateè¯­å¥æ—¶ï¼Œåœ¨whereæ¡ä»¶ä¸­åˆ¤æ–­åº“å­˜æ•°é‡æ˜¯å¦å˜åŠ¨ï¼Œè‹¥æœªå˜åŠ¨ï¼Œåˆ™è¡¨ç¤ºæ•°æ®æœªè¢«å…¶å®ƒå¹¶å‘çš„çº¿ç¨‹æ”¹åŠ¨ï¼Œåˆ™æˆåŠŸæ‰§è¡Œupdateè¯­å¥ã€‚

![image-20250806200219229](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806200219229.png)

![image-20250806223012755](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250806223012755.png)



##### ï¼ˆ4ï¼‰å®ç°ä¸€äººä¸€å•

â‘ ä¸€äººä¸€å•ï¼šåŒä¸€ä¸ªç”¨æˆ·æœ€å¤šåªèƒ½è´­ä¹°ä¸€ä¸ªç›¸åŒçš„ç§’æ€åˆ¸ã€‚

![image-20250807090722130](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807090722130.png)

â€‹	çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼šåœ¨å¤šçº¿ç¨‹å¹¶å‘è®¿é—®çš„æƒ…å†µä¸‹ï¼Œè‹¥æ•°æ®åº“ä¸­ä¸å­˜åœ¨ç”¨æˆ·Açš„è®¢å•ã€‚å‡è®¾10000ä¸ªç”¨æˆ·AåŒæ—¶æŸ¥è¯¢æ•°æ®åº“ï¼ŒæŸ¥è¯¢è®¢å•å‡ä¸å­˜åœ¨ï¼Œè¿™10000ä¸ªç”¨æˆ·Açš„è¯·æ±‚éƒ½å¯ä»¥è´­ä¹°è®¢å•ï¼Œé€ æˆä¸€äººå¤šå•ã€‚

â€‹	è§£å†³æ–¹æ¡ˆï¼šæ‚²è§‚é”ï¼ˆinsertç”¨æ‚²è§‚é”ï¼›updateç”¨ä¹è§‚é”ï¼‰



â‘¡åœ¨åˆ†å¸ƒå¼æ¨¡å¼ä¸‹ï¼Œsynchronizedäº’æ–¥é”å¤±æ•ˆï¼š

â€‹	çŸ¥è¯†ç‚¹è¡¥å……ï¼š**ä¸€å°tomcatå¯¹åº”ä¸€ä¸ªJVMï¼Œsynchronizedäº’æ–¥é”ä»…åœ¨å•ä¸ªJVMä¸­ç”Ÿæ•ˆï¼Œä¸èƒ½è·¨åŸŸï¼Œæ˜¯å•æœºé”ã€‚**

â€‹	åˆ†å¸ƒå¼æ¨¡å¼ä¸‹ï¼Œsynchronizedäº’æ–¥é”å¤±æ•ˆåŸå› ï¼šåˆ†å¸ƒå¼æ¨¡å¼ï¼Œæœ‰å¤šå°tomcatï¼Œå¯¹åº”å¤šä¸ªJVMï¼Œsynchronizedäº’æ–¥é”çš„ä½œç”¨åŸŸåªæ˜¯ä¸€å°JVMï¼Œä¸èƒ½è·¨åŸŸã€‚å› æ­¤ï¼Œå½“åˆ†å¸ƒå¼æ¨¡å¼ä¸­ï¼ŒåŒä¸€æ‰¹è¯·æ±‚è¢«è´Ÿè½½å‡è¡¡åˆ°å¤šå°tomcatï¼Œä¸åŒæœåŠ¡å™¨é—´ï¼Œäº‰æŠ¢åˆ°é”çš„çº¿ç¨‹ä»ä¼šå¹¶å‘æ‰§è¡Œï¼Œé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼

![image-20250807132414223](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807132414223.png)

         [è´Ÿè½½å‡è¡¡å™¨]
         /      |     \
       Tomcat1 Tomcat2 Tomcat3   â† 3ä¸ªç‹¬ç«‹çš„JVM
       (JVM1)  (JVM2)  (JVM3)
         |      |      |
        çº¿ç¨‹A   çº¿ç¨‹B   çº¿ç¨‹C     â† åŒä¸€ç”¨æˆ·çš„è¯·æ±‚è¢«åˆ†æ•£åˆ°ä¸åŒJVM
        ğŸ”’      ğŸ”’      ğŸ”’       â† å„JVMçš„é”äº’ä¸å¹²æ‰° â†’ é”å¤±æ•ˆ






## åŠŸèƒ½æ¨¡å—4ï¼šåˆ†å¸ƒå¼é”

##### ï¼ˆ1ï¼‰åˆ†å¸ƒå¼é” -- åŸºæœ¬æ¦‚å¿µ

åˆ†å¸ƒå¼é”å®ç°åŸç†ï¼šæä¾›ä¸€ä¸ªåˆ†å¸ƒå¼ä¸­ä¸åŒtomcaté—´çš„çº¿ç¨‹éƒ½å¯è§çš„äº’æ–¥çš„é”ã€‚

![image-20250807142440317](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807142440317.png)

![image-20250807143007306](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807143007306.png)

ä¸åŒå®ç°çš„åˆ†å¸ƒå¼é”çš„å¯¹æ¯”ï¼š

![image-20250807144246753](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807144246753.png)



##### ï¼ˆ2ï¼‰åŸºäºRediså®ç°åˆ†å¸ƒå¼é”

åˆ©ç”¨Redisçš„SETNXæŒ‡ä»¤ï¼Œå®ç°åˆ†å¸ƒå¼é”ï¼š

â€‹	ä¸ºä»€ä¹ˆSETNXå¯ä»¥ç”¨äºåˆ†å¸ƒå¼é”ï¼Ÿ	â‘ åŸå­æ€§ï¼šSETNXå‘½ä»¤æ˜¯åŸå­æ“ä½œï¼Œå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶å‘é€SETNXå‘½ä»¤æ—¶ï¼ŒRedisä¼šç¡®ä¿åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è®¾ç½®æˆåŠŸã€‚	â‘¡å…±äº«å­˜å‚¨ï¼šRedisæ˜¯ä¸€ä¸ªé›†ä¸­å¼çš„å­˜å‚¨æœåŠ¡ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯ï¼ˆæ— è®ºæ¥è‡ªå“ªä¸ªTomcatæˆ–JVMï¼‰éƒ½å¯ä»¥è®¿é—®åŒä¸€ä¸ªRediså®ä¾‹ï¼ˆæˆ–é›†ç¾¤ï¼‰ï¼Œå› æ­¤å¯ä»¥å®ç°è·¨JVMçš„é”ã€‚

![image-20250807151159906](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807151159906.png)



##### ï¼ˆ3ï¼‰Redisåˆ†å¸ƒå¼é”çš„è¯¯åˆ é—®é¢˜

**è¯¯åˆ å…¶ä»–å®¢æˆ·ç«¯çš„é”**ï¼š

   \- å¦‚æœå®¢æˆ·ç«¯Aåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘æ—¶è€—æ—¶è¿‡é•¿ï¼Œå¯¼è‡´é”è¿‡æœŸè‡ªåŠ¨é‡Šæ”¾ã€‚æ­¤æ—¶å®¢æˆ·ç«¯Bè·å–åˆ°é”ï¼Œç„¶åå®¢æˆ·ç«¯Aæ‰§è¡Œå®Œé€»è¾‘åï¼Œåˆå»åˆ é™¤é”ï¼Œå°±ä¼šè¯¯åˆ å®¢æˆ·ç«¯Bçš„é”ã€‚

   \- **è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨åˆ é™¤é”æ—¶ï¼Œå…ˆåˆ¤æ–­é”çš„å€¼æ˜¯å¦æ˜¯è‡ªå·±è®¾ç½®çš„ï¼ˆä½¿ç”¨éšæœºå­—ç¬¦ä¸²ä½œä¸ºå€¼ï¼‰ï¼Œç¡®ä¿åªèƒ½åˆ é™¤è‡ªå·±çš„é”ã€‚

å¦‚ä¸‹ï¼Œåˆ†å¸ƒå¼é”çš„è¯¯åˆ é—®é¢˜æµç¨‹ï¼š

![image-20250807201310939](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807201310939.png)

å¦‚ä¸‹ï¼Œä¸ºè§£å†³è¯¯åˆ é—®é¢˜åçš„æ­£ç¡®æµç¨‹ï¼š

![image-20250807201611159](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807201611159.png)

![image-20250807203821556](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807203821556.png)

æ”¹è¿›Redisçš„åˆ†å¸ƒå¼é”ï¼Œè§£å†³è¯¯åˆ é—®é¢˜ï¼š

![image-20250807222321037](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250807222321037.png)



##### ï¼ˆ4ï¼‰Redisåˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜ï¼Œä¸Luaè„šæœ¬

â‘ Redisåˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜

â€‹	åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜ï¼šé‡Šæ”¾é”çš„æ­¥éª¤åˆ†ä¸ºä¸¤æ­¥ã€â‘ è‹¥åˆ¤æ–­é”ä¸­çš„å€¼æ˜¯è‡ªå·±è®¾ç½®çš„ï¼Œâ‘¡åˆ é™¤é”ã€‘ã€‚è‹¥åŸæœ¬å®¢æˆ·ç«¯Aå°†è¦é‡Šæ”¾é”Aï¼Œå½“æ‰§è¡Œå®Œæ­¥éª¤â‘ åï¼ŒAçº¿ç¨‹é˜»å¡ï¼Œé˜»å¡æœŸé—´Aé”è¶…æ—¶è¿‡æœŸã€‚æ­¤æ—¶å®¢æˆ·ç«¯Bè·å–åˆ°é”Bï¼Œä¸€æ®µæ—¶é—´åå®¢æˆ·ç«¯Aé˜»å¡ç»“æŸï¼Œç»§ç»­æ‰§è¡Œæ­¥éª¤â‘¡ï¼Œå°†é”Bè¯¯åˆ é™¤ã€‚

â€‹	é—®é¢˜åŸå› ï¼šæ­¥éª¤â‘ ã€â‘¡ä¸å…·æœ‰åŸå­æ€§ã€‚

â€‹	è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨Luaè„šæœ¬ã€‚

![image-20250808092607810](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808092607810.png)



â‘¡Luaè„šæœ¬ä»‹ç»

Luaè„šæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

![image-20250808101344277](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808101344277.png)

![image-20250808102851992](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808102851992.png)



â‘¢ä½¿ç”¨Luaè„šæœ¬ï¼Œè§£å†³åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜

æ³¨æ„ï¼šåŒä¸€ä¸ªLuaè„šæœ¬ä¸­çš„å¤šæ¡Redisè¯­å¥ï¼Œæ‰§è¡Œæ—¶å…·æœ‰åŸå­æ€§ã€‚

é‡Šæ”¾é”çš„Luaè„šæœ¬ï¼š

![image-20250808104954622](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808104954622.png)

ä½¿ç”¨Javaçš„RedisTemplateæ‰§è¡ŒLuaè„šæœ¬ï¼š

![image-20250808112008776](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808112008776.png)



##### ï¼ˆ5ï¼‰Redisson

â‘ RedissonåŸºæœ¬æ¦‚å¿µ

â€‹	Redissonæ˜¯ä¸€ä¸ªåŸºäºRedisçš„åˆ†å¸ƒå¼å¼€å‘å·¥å…·åŒ…ã€‚

â€‹	Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ï¼Œå®ƒæä¾›äº†åˆ†å¸ƒå¼å’Œå¯æ‰©å±•çš„Javaæ•°æ®ç»“æ„ï¼Œä»¥åŠè®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ã€‚å®ƒæ”¯æŒåŒæ­¥ã€å¼‚æ­¥å’Œååº”å¼ç¼–ç¨‹æ¨¡å‹ã€‚Redissonçš„ç›®æ ‡æ˜¯è®©å¼€å‘è€…èƒ½å¤Ÿä»¥æœ€å°çš„å­¦ä¹ æ›²çº¿ä½¿ç”¨Redisï¼ŒåŒæ—¶æä¾›å¼ºå¤§çš„åŠŸèƒ½ã€‚

![image-20250808135632041](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808135632041.png)

è¡¥å……ï¼šåŸºç¡€Redisé”å­˜åœ¨çš„é—®é¢˜ï¼ˆRedissonä¼šå¯¹è¿™äº›é—®é¢˜åšå‡ºä¼˜åŒ–ï¼‰

![image-20250808191218705](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808191218705.png)



â‘¡Redissonä»£ç å…¥é—¨

![image-20250808141833757](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808141833757.png)

![image-20250808144646034](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808144646034.png)



â‘¢**Redissonçš„å¯é‡å…¥é”**

â€‹	Redissonçš„å¯é‡å…¥é”ï¼ˆReentrant Lockï¼‰æ˜¯Redissonæä¾›çš„ä¸€ç§åˆ†å¸ƒå¼å¯é‡å…¥äº’æ–¥é”ï¼Œå®ƒå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œè€Œä¸ä¼šå¯¼è‡´æ­»é”ã€‚è¿™ç§é”æ˜¯Redissonä¸­æœ€å¸¸ç”¨çš„é”ä¹‹ä¸€ï¼Œé€‚ç”¨äºéœ€è¦ä¸¥æ ¼æ§åˆ¶å…±äº«èµ„æºè®¿é—®çš„åˆ†å¸ƒå¼åœºæ™¯ã€‚

â€‹	æ ¸å¿ƒç‰¹æ€§ï¼š

â€‹		1.**å¯é‡å…¥æ€§**ï¼šåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œæ¯æ¬¡è·å–é”åéœ€è¦ç›¸åº”æ¬¡æ•°çš„é‡Šæ”¾æ‰èƒ½å®Œå…¨é‡Šæ”¾é”ã€‚

â€‹		2.**é”ç»­æœŸï¼ˆWatchdogï¼‰**ï¼šé”é»˜è®¤çš„ç§Ÿçº¦æ—¶é—´ä¸º30ç§’ï¼Œä½†é€šè¿‡çœ‹é—¨ç‹—æœºåˆ¶ï¼Œå¦‚æœä¸šåŠ¡æœªæ‰§è¡Œå®Œï¼Œä¼šè‡ªåŠ¨ç»­æœŸé”ï¼Œé¿å…ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿å¯¼è‡´é”è‡ªåŠ¨é‡Šæ”¾ã€‚

â€‹		3.**å…¬å¹³é”ä¸éå…¬å¹³é”**ï¼šRedissonæä¾›äº†å…¬å¹³é”å’Œéå…¬å¹³é”ä¸¤ç§æ¨¡å¼ã€‚

â€‹		4.**é”é‡Šæ”¾æ ¡éªŒ**ï¼šé‡Šæ”¾é”æ—¶ä¼šæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰é”ï¼Œé¿å…è¯¯åˆ å…¶ä»–çº¿ç¨‹çš„é”ã€‚

â€‹		5.**é«˜å¯ç”¨**ï¼šæ”¯æŒRediså•èŠ‚ç‚¹ã€ä¸»ä»ã€å“¨å…µã€é›†ç¾¤ç­‰å¤šç§éƒ¨ç½²æ¨¡å¼ã€‚

![image-20250808162751048](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808162751048.png)

--è·å–é”çš„Luaè„šæœ¬

![image-20250808163741191](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808163741191.png)

--é‡Šæ”¾é”çš„Luaè„šæœ¬

![image-20250808163858436](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808163858436.png)



â‘£**Redissonçš„é”é‡è¯•å’Œçœ‹é—¨ç‹—æœºåˆ¶**

â€‹	1.ç­‰å¾…æ—¶é—´ï¼ˆWait Timeï¼‰

â€‹		--å®šä¹‰ï¼šå°è¯•è·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´ã€‚å¦‚æœåœ¨è¿™æ®µæ—¶é—´å†…æœªèƒ½è·å–é”ï¼Œåˆ™æ”¾å¼ƒè·å–ã€‚

â€‹		--è¡Œä¸ºï¼šåœ¨ç­‰å¾…æ—¶é—´å†…ï¼Œå®¢æˆ·ç«¯ä¼šå‘¨æœŸæ€§åœ°å°è¯•è·å–é”ï¼ˆå†…éƒ¨æœ‰é‡è¯•æœºåˆ¶ï¼Œé‡è¯•é—´éš”ç”±é…ç½®å†³å®šï¼‰ã€‚å¦‚æœåœ¨ç­‰å¾…æ—¶é—´å†…è·å–åˆ°é”ï¼Œåˆ™è¿”å›`true`ï¼›å¦‚æœè¶…æ—¶ä»æœªè·å–ï¼Œåˆ™è¿”å›`false`ã€‚

â€‹	2.è¿‡æœŸæ—¶é—´ï¼ˆLease Time / Expiration Timeï¼‰

â€‹		--å®šä¹‰ï¼šé”è¢«è‡ªåŠ¨é‡Šæ”¾çš„æ—¶é—´ã€‚å³è·å–é”åï¼Œå³ä½¿æ²¡æœ‰æ˜¾å¼é‡Šæ”¾ï¼Œé”ä¹Ÿä¼šåœ¨è¿™ä¸ªæ—¶é—´åè‡ªåŠ¨è¿‡æœŸï¼Œé˜²æ­¢æ­»é”ã€‚

â€‹		--æ³¨æ„ï¼šåœ¨Redissonä¸­ï¼Œè¿‡æœŸæ—¶é—´ä¹Ÿç§°ä¸ºç§Ÿçº¦æ—¶é—´ï¼ˆlease timeï¼‰ã€‚

â€‹		--ä¸çœ‹é—¨ç‹—çš„å…³ç³»ï¼šå¦‚æœåœ¨è·å–é”æ—¶**æŒ‡å®šäº†ç§Ÿçº¦æ—¶é—´**ï¼ˆlease timeï¼‰ï¼Œåˆ™é”ä¸ä¼šè‡ªåŠ¨ç»­æœŸï¼Œåˆ°æœŸè‡ªåŠ¨é‡Šæ”¾ï¼›å¦‚æœåœ¨è·å–é”æ—¶**æ²¡æœ‰æŒ‡å®šç§Ÿçº¦æ—¶é—´**ï¼ˆå³ä½¿ç”¨`lock()`æˆ–`tryLock()`ä¸å¸¦ç§Ÿçº¦æ—¶é—´å‚æ•°ï¼‰ï¼Œåˆ™Redissonä¼šå¯åŠ¨ä¸€ä¸ªâ€œçœ‹é—¨ç‹—â€ï¼ˆWatchdogï¼‰çº¿ç¨‹æ¥å®šæœŸç»­æœŸé”ï¼Œé»˜è®¤ç»­æœŸæ—¶é—´ä¸º30ç§’ï¼Œå¹¶ä¸”æ¯10ç§’ç»­æœŸä¸€æ¬¡ï¼ˆå³æ¯æ¬¡å°†é”çš„è¿‡æœŸæ—¶é—´é‡ç½®ä¸º30ç§’ï¼‰ã€‚

![image-20250808205442740](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808205442740.png)

![image-20250808210023561](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808210023561.png)

æ€»ç»“ä¸åŒçš„Redisåˆ†å¸ƒå¼é”ï¼š

![image-20250808222238256](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250808222238256.png)





## åŠŸèƒ½æ¨¡å—5ï¼šç§’æ€ä¼˜åŒ–

##### ï¼ˆ1ï¼‰å¼‚æ­¥ç§’æ€

â‘ å¼‚æ­¥ç§’æ€ -- æ€è·¯

ä¼˜åŒ–å‰çš„â€œä¼˜æƒ åˆ¸ç§’æ€â€æµç¨‹å¦‚ä¸‹ï¼š

![image-20250810125950885](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250810125950885.png)

ä¼˜åŒ–åçš„â€œä¼˜æƒ åˆ¸ç§’æ€â€æµç¨‹å¦‚ä¸‹ï¼š

![image-20250810133139681](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250810133139681.png)



â‘¡å¼‚æ­¥ç§’æ€ -- ç§’æ€èµ„æ ¼çš„åˆ¤æ–­

ä½¿ç”¨Redisä¼˜åŒ–ç§’æ€èµ„æ ¼çš„åˆ¤æ–­ï¼š

![image-20250810134703955](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250810134703955.png)

![image-20250810142039528](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250810142039528.png)

å¼‚æ­¥ç§’æ€ä¼˜åŒ–çš„æ€»ç»“ï¼š

![image-20250810204905527](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20250810204905527.png)